<script>
    const API_KEY = '96e49f1454195e418c84e5f6'; 
    
    // 1. ADD FALLBACK DATA so it's never blank
    let rates = { "USD": 1, "INR": 82.9, "EUR": 0.92, "GBP": 0.79, "JPY": 151.0, "CAD": 1.35 };

    function getFlag(code) {
        try {
            if (code === 'EUR') return 'ðŸ‡ªðŸ‡º';
            if (code === 'EGP') return 'ðŸ‡ªðŸ‡¬';
            if (!code || code.length < 2) return 'ðŸŒ';
            const countryCode = code.substring(0, 2);
            return countryCode.toUpperCase().replace(/./g, char => 
                String.fromCodePoint(char.charCodeAt(0) + 127397)
            );
        } catch (e) { return 'ðŸŒ'; }
    }

    const currencyNames = {
        "INR": "Indian Rupee", "USD": "US Dollar", "EUR": "Euro", "GBP": "British Pound",
        "JPY": "Japanese Yen", "AUD": "Australian Dollar", "CAD": "Canadian Dollar",
        "MXN": "Mexican Peso", "AED": "UAE Dirham", "SGD": "Singapore Dollar"
    };

    async function fetchRates() {
        try {
            const response = await fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/latest/USD`);
            const data = await response.json();
            
            if (data.result === "success") {
                rates = data.conversion_rates;
                populateCurrencyList();
                document.getElementById('updateStatus').innerText = "All World Currencies Synced";
            } else {
                throw new Error("API Key issue");
            }
        } catch (error) {
            console.error(error);
            document.getElementById('updateStatus').innerText = "Offline: Using Saved Rates";
            populateCurrencyList(); // Populate anyway even if fetch fails
        }
    }

    function populateCurrencyList(filter = "") {
        const select = document.getElementById('currencyList');
        const currentSelection = select.value || "INR";
        select.innerHTML = "";
        
        const codes = Object.keys(rates).sort();
        const filteredCodes = codes.filter(code => {
            const name = currencyNames[code] || "";
            return code.toLowerCase().includes(filter.toLowerCase()) || 
                   name.toLowerCase().includes(filter.toLowerCase());
        });

        if (filteredCodes.length === 0) {
            const opt = document.createElement('option');
            opt.innerText = "No results found";
            select.appendChild(opt);
            return;
        }

        filteredCodes.forEach(code => {
            const option = document.createElement('option');
            option.value = code;
            const flag = getFlag(code);
            const name = currencyNames[code] ? ` (${currencyNames[code]})` : "";
            option.innerText = `${flag} ${code}${name}`;
            if (code === currentSelection) option.selected = true;
            select.appendChild(option);
        });
        convert();
    }

    function filterCurrencies() {
        populateCurrencyList(document.getElementById('searchBar').value);
    }

    function clearInput() {
        document.getElementById('localPrice').value = "";
        convert();
    }

    function convert() {
        const localAmount = parseFloat(document.getElementById('localPrice').value) || 0;
        const currencyCode = document.getElementById('currencyList').value;
        const feePercent = parseFloat(document.getElementById('fee').value) || 0;

        if (rates[currencyCode]) {
            const baseUSD = localAmount / rates[currencyCode];
            const totalUSD = baseUSD * (1 + (feePercent / 100));
            document.getElementById('totalUSD').innerText = '$' + totalUSD.toLocaleString(undefined, {
                minimumFractionDigits: 2, maximumFractionDigits: 2
            });
        }
    }

    // 2. INITIAL CALLS
    populateCurrencyList(); // Show list immediately
    fetchRates();           // Then try to update it
</script>
